<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>NAND Flash System - Free60 Wiki archive</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Free60 Wiki archive</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../%21TODO/" class="nav-link">ToDo</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#nand-flash-system" class="nav-link">NAND Flash System</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#nand-basic-format" class="nav-link">NAND Basic Format</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#metadata" class="nav-link">Metadata</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#error-detectioncorrection-code" class="nav-link">Error Detection/Correction Code</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#nand-format" class="nav-link">NAND Format</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="nand-flash-system">NAND Flash System</h1>
<p>The Xbox 360 NAND uses a proprietary format created by Microsoft. The
format is used to store console-specific data (keyvault, config blocks,
etc) and system data (bootloaders, kernel/hypervisor, dashboard files).
The NAND is split into two sections - one for storing the keyvault,
bootloaders and config blocks and one for storing the dashboard files.
The file are stored using a format which is designed to be transactional
(each change can be reverted).</p>
<h2 id="nand-basic-format">NAND Basic Format</h2>
<p>The NAND uses a series of pages to combine into blocks, which are small
snippets of data (usually 512 bytes) which each have an EDC tag at the
end (an extra 16 bytes or 64 in bigblock). These pages are each part of
a specific block (which can be identified with the EDC), which is
usually made with 16 pages (or 32 for bigblock NANDs)</p>
<h2 id="metadata">Metadata</h2>
<p>All (non-eMMC) NANDs have specific Spare-/Metadata for each page inside
the NAND. Sometimes it will not be dumped with the NAND, so it has to
either be added back or redumped. The Metadata contains the pages block
number, a series of flags and a checksum. Those differ slightly,
depending on the
blocksize.</p>
<h3 id="small-block">Small Block</h3>
<pre><code class="c">unsigned char BlockID1; // lba/id = (((BlockID0&amp;0xF)&lt;&lt;8)+(BlockID1))
unsigned char BlockID0 : 4;
unsigned char FsUnused0 : 4;
unsigned char FsSequence0; // Not reversed
unsigned char FsSequence1;
unsigned char FsSequence2;
unsigned char BadBlock;
unsigned char FsSequence3;
unsigned char FsSize1; // ((FsSize0&lt;&lt;8)+FsSize1) = cert size
unsigned char FsSize0;
unsigned char FsPageCount; // free pages left in block (ie: if 3 pages are used by cert then this would be 29:0x1d)
unsigned char FsUnused1[0x2];
unsigned char FsBlockType : 6;
unsigned char ECC3 : 2;
unsigned char ECC2; // 14 bit ECD
unsigned char ECC1;
unsigned char ECC0;
</code></pre>

<h3 id="big-block-on-small-nand">Big Block on Small NAND</h3>
<pre><code class="c">unsigned char FsSequence0;
unsigned char BlockID1; // lba/id = (((BlockID0&lt;&lt;8)&amp;0xF)+(BlockID1&amp;0xFF))
unsigned char BlockID0 : 4; 
unsigned char FsUnused0 : 4;
unsigned char FsSequence1;
unsigned char FsSequence2;
unsigned char BadBlock;
unsigned char FsSequence3;
unsigned char FsSize1; // (((FsSize0&lt;&lt;8)&amp;0xFF)+(FsSize1&amp;0xFF)) = cert size
unsigned char FsSize0;
unsigned char FsPageCount; // free pages left in block (ie: if 3 pages are used by cert then this would be 29:0x1d)
unsigned char FsUnused1[2];
unsigned char FsBlockType : 6;
unsigned char ECC3 : 2;
unsigned char ECC2; // 14 bit ECD
unsigned char ECC1;
unsigned char ECC0;
</code></pre>

<h3 id="big-block">Big Block</h3>
<pre><code class="c">unsigned char BadBlock;
unsigned char BlockID1; // lba/id = (((BlockID0&amp;0xF)&lt;&lt;8)+(BlockID1&amp;0xFF))
unsigned char BlockID0 : 4;
unsigned char FsUnused0 : 4;
unsigned char FsSequence2; // oddly, compared to before these are reversed...?
unsigned char FsSequence1;
unsigned char FsSequence0;
unsigned char FsUnused1;
unsigned char FsSize1; // FS: 06 ((FsSize0&lt;&lt;16)+(FsSize1&lt;&lt;8)+FsSize2) = cert size
unsigned char FsSize0; // FS: 20
unsigned char FsPageCount; // FS: 04 free pages left in block (multiples of 4 pages, ie if 3f then 3f*4 pages are free after)
unsigned char FsUnused2[0x2];
unsigned char FsBlockType : 6; // FS: 2a bitmap: 2c (both use FS: vals for size), mobiles
unsigned char ECC3 : 2;
unsigned char ECC2; // 14 bit ECD
unsigned char ECC1;
unsigned char ECC0;
</code></pre>

<h2 id="error-detectioncorrection-code">Error Detection/Correction Code</h2>
<p>The ECC/EDC checksum uses a custom algorithm - here is C code for
that:</p>
<pre><code class="cpp">int checkEcc(u8* datc, u8* spare)
{
unsigned int i=0, val=0;
unsigned char edc[4] = {0,0,0,0};
unsigned long * data = (unsigned long*) datc;

unsigned int v=0;
// printf(&quot;original ECC  : %02x %02x %02x %02x &quot;, (spare[0xC] &amp; 0xC0), spare[0xD],spare[0xE],spare[0xF]);

for (i = 0; i &lt; 0x1066; i++)
{
   if (!(i &amp; 31))
   {
       if (i == 0x1000)
       data = (unsigned long*)spare;
       v = ~*data++; // byte order: LE 
   }
       val ^= v &amp; 1;
       v&gt;&gt;=1;
       if (val &amp; 1)
           val ^= 0x6954559;
   val &gt;&gt;= 1;
}

val = ~val;

edc[0] = (val &lt;&lt; 6) &amp; 0xC0;
edc[1] = (val &gt;&gt; 2) &amp; 0xFF;
edc[2] = (val &gt;&gt; 10) &amp; 0xFF;
edc[3] = (val &gt;&gt; 18) &amp; 0xFF;

if(((spare[0xC] &amp; 0xC0) != edc[0])||(spare[0xD] != edc[1])||(spare[0xE] != edc[2])||(spare[0xF] != edc[3]))
   return ECC_FAILED;

return ECC_CORRECT;
}
</code></pre>

<h2 id="nand-format">NAND Format</h2>
<p>The first byte of a NAND image should always be 0xFF. If it isn't 0xFF
this isn't a valid image. Another thing which should be checked is the
copyright header, which is located at 0x10 in the NAND. This string
should be read in two parts (skipping the year out, as it changes
depending when that xbox was made) and then checked against a control
string (although some valid images have this string changed to
zeropair).</p>
<p>At 0x2 in the NAND the version of the flash is stored (2bytes). Further
on at 0x8 the offset of the CB is stored, followed by the CF1 offset
(4bytes each).</p>
<p>At 0x6C the offset to the keyvault is located (4bytes). Up from that at
0x78 the length of the SMC and offset to the SMC are stored (4bytes
each).</p>
<h3 id="system-management-controller">System Management Controller</h3>
<p>finish later</p>
<h3 id="xell-image-layout">XeLL Image Layout</h3>
<p>The whole XeLL Image is pretty small with 1,3 MB compared to an original
Xbox360 NAND-Image which is normally 16 MB or 64 MB.</p>
<p>0x00000000..0x000001ff (0x00000200 bytes) Header
0x00000200..0x000003ff (0x00000200 bytes) Exploit
0x00000400..0x00000fff (0x00000c00 bytes) Padding
0x00001000..0x00003fff (0x00003000 bytes) SMC
0x00004000..0x00007fff (0x00004000 bytes) Keyvault
0x00008000..0x000117ff (0x00009800 bytes) CB 1921
0x00011800..0x00016ebf (0x000056c0 bytes) CD 1921
0x00016ec0..0x0006cf2f (0x00056070 bytes) CE 1888
0x0006cf30..0x0006ffff (0x000030d0 bytes) Padding
0x00070000..0x000744bf (0x000044c0 bytes) CF 4532
0x000744c0..0x000a33ff (0x0002ef40 bytes) CG 4532
0x000a3400..0x000bffff (0x0001cc00 bytes) Padding
0x000c0000..0x000fffff (0x00040000 bytes) Xell (backup)
0x00100000..0x0013ffff (0x00040000 bytes) Xell (main)</p>
<ul>
<li>The (hacked) SMC Code is usually seen as Header + Exploit + Padding</li>
<li>the actual SMC, so 0x0000 - 0x3FFF.</li>
<li>The Keyvault is the unique "System Information" which holds stuff
  like DVDKey, Console Region, Console Serial and other things. Whole
  keyvault is crypted with CPUKey.</li>
<li>After that exploitable CB (2BL) and CD (4BL), matching the console
  revision, follows.</li>
<li>After padding CB/CD theres CE (Base-Kernel 1888) followed by
  exploitable Patchslots CF/CG (4532 or 4548) and again some padding.</li>
<li>At the end of the Image theres a Backup-XeLL, which gets executed if
  the original XeLL fails (Bad Update maybe) followed by the original
  XeLL.</li>
</ul>
<p><a href="../Category_Xbox360_System_Software">Category:Xbox360 System Software</a></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
